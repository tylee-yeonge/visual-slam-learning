"""
Phase 1 - Week 3: SVD 퀴즈
===========================
SVD 개념 확인을 위한 주관식 퀴즈

사용법:
1. 먼저 문제를 읽고 직접 풀어보세요
2. 답을 확인하려면 파일 하단의 "답안" 섹션을 참고하세요
"""

import numpy as np
np.set_printoptions(precision=4, suppress=True)

print("=" * 60)
print("Phase 1 - Week 3: SVD 퀴즈")
print("=" * 60)

# ============================================================
# 주관식 문제
# ============================================================

print("\n" + "=" * 60)
print("📝 주관식 문제")
print("=" * 60)

# ----------------------------------------------------------
# 문제 1: SVD 기본
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 문제 1: SVD 분해

다음 행렬 A의 SVD 분해에서 특이값들을 구하세요.
""")

A1 = np.array([
    [3, 0],
    [0, 2]
])

print("A =")
print(A1)
print("\n질문: A의 특이값 σ₁, σ₂는?")
print("(힌트: 대각 행렬의 SVD 특성을 생각해보세요)")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 문제 2: 특이값과 랭크
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 문제 2: 특이값과 랭크

다음 행렬의 랭크는 얼마인가요?
""")

A2 = np.array([
    [1, 2, 3],
    [2, 4, 6],
    [3, 6, 9]
])

print("A =")
print(A2)
print("\n질문: A의 랭크는?")
print("(힌트: 행들 사이의 관계를 관찰하세요)")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 문제 3: 기하학적 의미
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 문제 3: 기하학적 의미

SVD에서 A = UΣVᵀ일 때, 다음을 답하세요:

질문 3-1: Vᵀ는 기하학적으로 무엇을 나타내는가?
질문 3-2: Σ는 기하학적으로 무엇을 나타내는가?
질문 3-3: U는 기하학적으로 무엇을 나타내는가?
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 문제 4: 최소자승 해
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 문제 4: 최소자승 해

Ax = b의 최소자승 해를 SVD로 구하는 공식을 완성하세요.

A = UΣVᵀ일 때, x = ?
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 문제 5: Null Space
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 문제 5: Null Space

Ax = 0의 해(null space)를 SVD에서 어떻게 찾나요?
""")

U5, S5, Vt5 = np.linalg.svd(A2)
print(f"행렬 A (문제 2와 동일)의 특이값: {S5}")
print("\n질문: Ax = 0의 해는 SVD의 어느 부분에서 찾는가?")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 문제 6: 직교 행렬 성질
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 문제 6: 직교 행렬 성질

SVD에서 U와 V가 직교 행렬이라면:

질문 6-1: UᵀU = ?
질문 6-2: VVᵀ = ?
질문 6-3: U의 열벡터들 사이의 관계는?
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 문제 7: Essential Matrix
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 문제 7: SLAM 응용 - Essential Matrix

Essential Matrix E의 SVD 분해 결과가 다음과 같을 때:
- 특이값: [1.0, 1.0, 0.0]

질문 7-1: 이상적인 Essential Matrix의 특이값은 어떤 형태인가?
질문 7-2: 왜 마지막 특이값이 0인가?
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 문제 8: 저랭크 근사
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 문제 8: 저랭크 근사

100×100 행렬의 특이값이 [100, 50, 10, 1, 0.1, ...] 형태로 급격히 감소할 때:

질문: 상위 3개 특이값만 사용하면 원본 정보의 대략 몇 %를 보존하는가?
(힌트: 에너지 = 특이값 제곱의 합)
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 문제 9: 조건수
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 문제 9: 조건수 (Condition Number)

다음 행렬의 조건수를 구하세요.
""")

A9 = np.array([
    [1, 0],
    [0, 0.001]
])

print("A =")
print(A9)
print("\n질문: 조건수 = σ_max / σ_min = ?")
print("(조건수가 크면 수치적으로 불안정)")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 문제 10: SLAM 응용
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 문제 10: SLAM 응용 종합

SVD가 사용되는 SLAM 관련 문제를 3가지 이상 나열하세요.
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 문제 11: 직사각 행렬 SVD
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 문제 11: 직사각 행렬 SVD

다음 3×2 행렬 A의 SVD 분해에서:
""")

A11 = np.array([
    [1, 2],
    [3, 4],
    [5, 6]
])

print("A =")
print(A11)
print("""
질문 11-1: U, Σ, Vᵀ 각각의 크기는?
질문 11-2: Σ 행렬은 어떤 모양인가? (0이 어디에 있는지)
질문 11-3: 반대로 2×4 행렬이면 Σ 행렬은 어떤 모양인가?
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")


# ============================================================
# ============================================================
#
#                    📋 답안 (아래로 스크롤)
#
# ============================================================
# ============================================================



























print("\n" + "=" * 60)
print("📋 답안")
print("=" * 60)

# ----------------------------------------------------------
# 답 1
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 답 1: SVD 분해
""")
_, S1_ans, _ = np.linalg.svd(A1)
print(f"특이값: σ₁ = {S1_ans[0]}, σ₂ = {S1_ans[1]}")
print("""
설명:
- 대각 행렬의 특이값 = 대각 원소의 절댓값
- 특이값은 항상 양수이고 내림차순으로 정렬됨
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 답 2
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 답 2: 특이값과 랭크
""")
_, S2_ans, _ = np.linalg.svd(A2)
print(f"특이값: {S2_ans}")
rank2 = np.sum(S2_ans > 1e-10)
print(f"\n답: 랭크 = {rank2}")
print("""
설명:
- 2행 = 2 × 1행, 3행 = 3 × 1행
- 모든 행이 첫 번째 행의 스칼라 배수
- 독립인 행은 1개뿐 → 랭크 = 1
- 0이 아닌 특이값의 개수 = 랭크
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 답 3
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 답 3: 기하학적 의미

답 3-1: Vᵀ = 첫 번째 회전 (입력 공간에서 좌표축 정렬)
답 3-2: Σ = 축 방향 스케일링 (각 방향으로 늘이기/줄이기)
답 3-3: U = 두 번째 회전 (출력 공간에서 최종 방향 조정)

요약:
모든 선형 변환 = 회전 → 스케일 → 회전
(단위 원 → 정렬된 타원 → 최종 타원)
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 답 4
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 답 4: 최소자승 해

답: x = V Σ⁺ Uᵀ b

여기서:
- Σ⁺는 Σ의 유사역행렬 (Moore-Penrose pseudoinverse)
- σᵢ → 1/σᵢ (σᵢ ≠ 0인 경우)
- σᵢ = 0이면 0으로 유지

이것이 A⁺ = V Σ⁺ Uᵀ (유사역행렬) 공식
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 답 5
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 답 5: Null Space
""")
null_vectors = Vt5[np.abs(S5) < 1e-10, :]
print(f"σ ≈ 0인 특이값 개수: {np.sum(np.abs(S5) < 1e-10)}")
print("\n답: Null space = σ = 0에 대응하는 V의 열벡터들")
print("    (또는 Vᵀ의 해당 행벡터들)")
print(f"\nNull space 벡터들:\n{null_vectors}")

# 검증
for v in null_vectors:
    result = A2 @ v
    print(f"\nA @ v = {result}")
    print(f"영벡터인가? {np.allclose(result, 0)}")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 답 6
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 답 6: 직교 행렬 성질

답 6-1: UᵀU = I (단위행렬)
답 6-2: VVᵀ = I (단위행렬)
답 6-3: U의 열벡터들은 서로 직교하고 크기가 1 (정규직교)

추가:
- 직교 행렬의 역행렬 = 전치행렬
- U⁻¹ = Uᵀ, V⁻¹ = Vᵀ
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 답 7
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 답 7: Essential Matrix

답 7-1: 이상적인 Essential Matrix의 특이값 = [σ, σ, 0]
        (두 개의 같은 특이값 + 하나의 0)

답 7-2: Essential Matrix E = t× R 형태
        - t×는 반대칭 행렬 (skew-symmetric)
        - 반대칭 행렬의 랭크는 최대 2
        - 따라서 세 번째 특이값은 반드시 0

SLAM에서의 의미:
- E의 랭크가 2라는 제약조건
- R, t 추출 시 SVD로 분해하여 활용
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 답 8
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 답 8: 저랭크 근사
""")
# 에너지 계산
singular_values = np.array([100, 50, 10, 1, 0.1])
total_energy = np.sum(singular_values**2)
top3_energy = np.sum(singular_values[:3]**2)
percentage = top3_energy / total_energy * 100

print(f"전체 에너지: {total_energy}")
print(f"상위 3개 에너지: {top3_energy}")
print(f"\n답: 약 {percentage:.1f}%의 정보 보존")
print("""
설명:
- 에너지 = Σ σᵢ² (프로베니우스 노름의 제곱)
- 상위 특이값들이 대부분의 정보를 담고 있음
- 이것이 이미지 압축, PCA 등의 원리
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 답 9
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 답 9: 조건수
""")
_, S9_ans, _ = np.linalg.svd(A9)
cond_num = S9_ans[0] / S9_ans[-1]
print(f"특이값: {S9_ans}")
print(f"\n답: 조건수 = {S9_ans[0]} / {S9_ans[-1]} = {cond_num}")
print("""
의미:
- 조건수가 크면 → 수치적으로 불안정 (ill-conditioned)
- 작은 입력 오차가 큰 출력 오차로 증폭
- SLAM에서: 특이 상황(degenerate case) 탐지에 활용
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 답 10
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 답 10: SLAM 응용 종합

SVD가 사용되는 SLAM 문제들:

1. Essential Matrix 분해
   - E에서 R(회전), t(평행이동) 추출
   
2. Homography 분해
   - H에서 R, t, n(평면 법선) 추출

3. PnP 문제
   - 3D-2D 대응점에서 카메라 포즈 추정
   - DLT(Direct Linear Transform) 해법

4. Triangulation
   - 두 시점에서 3D 점 위치 추정
   - Ax = 0 형태의 해 구하기

5. Fundamental Matrix 계산
   - 8점 알고리즘에서 동차 시스템 해

6. 회전 행렬 정규화
   - 최적화 후 직교성 깨진 R을 SVD로 복원
   - R = U @ Vᵀ (가장 가까운 직교 행렬)

7. 저랭크 근사 / 노이즈 제거
   - 측정 행렬의 노이즈 제거
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ----------------------------------------------------------
# 답 11
# ----------------------------------------------------------
print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 답 11: 직사각 행렬 SVD
""")
U11, S11, Vt11 = np.linalg.svd(A11, full_matrices=True)
print(f"A 크기: {A11.shape}")
print(f"U 크기: {U11.shape}")  
print(f"특이값: {S11}")
print(f"Vᵀ 크기: {Vt11.shape}")

print("""
답 11-1: 크기
   - U: 3×3 (m×m)
   - Σ: 3×2 (m×n, 원본과 동일!)
   - Vᵀ: 2×2 (n×n)

답 11-2: Σ 행렬 모양 (m>n, 행이 더 많은 경우)""")
Sigma11 = np.zeros((3, 2))
Sigma11[:2, :2] = np.diag(S11)
print(Sigma11)
print("""   → 아래에 0으로 된 행이 추가됨

답 11-3: 2×4 행렬이면 (m<n, 열이 더 많은 경우)
   Σ = [σ₁  0   0   0]
       [0   σ₂  0   0]
   → 오른쪽에 0으로 된 열이 추가됨

공식: A(m×n) = U(m×m) × Σ(m×n) × Vᵀ(n×n)
""")
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

# ============================================================
# 점수 확인
# ============================================================
print("\n" + "=" * 60)
print("📊 자가 채점")
print("=" * 60)
print("""
각 문제당 9점, 총 100점 (11문제 × 9점 ≈ 100점)

✅ 10-11문제: 완벽! Week 4로 진행
✅ 7-9문제: 잘하고 있어요, 틀린 부분 복습 후 진행
⚠️ 4-6문제: SVD 이론 다시 복습 권장
❌ 0-3문제: 3Blue1Brown SVD 영상 시청 필요

💡 SLAM 관련 문제 (7, 10)와 직사각 행렬 (11)이 특히 중요합니다!
""")
