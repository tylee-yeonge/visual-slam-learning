# Week 1: 핀홀 카메라 모델

## 📌 개요

> 🎯 **목표**: 3D 세계가 어떻게 2D 이미지로 변환되는지 이해하기
> ⏱️ **예상 시간**: 이론 2시간 + 실습 2시간

**핀홀 카메라 모델**은 가장 기본적인 카메라 수학 모델입니다. 모든 Visual SLAM 시스템은 이 모델을 기반으로 3D 점을 2D 이미지에 투영하거나, 역으로 2D 이미지에서 3D 정보를 복원합니다.

### 🤔 왜 이걸 배워야 할까요?

**일상 비유**: 스마트폰으로 사진을 찍을 때 무슨 일이 일어날까요?

1. 3D 세계의 물체에서 빛이 반사됨
2. 빛이 렌즈(작은 구멍)를 통과
3. 센서(2D 평면)에 상이 맺힘
4. 2D 이미지 생성!

**SLAM에서의 활용**:
- 카메라가 보는 3D 점을 이미지 픽셀로 변환
- 재투영 오차(Reprojection Error) 계산
- VINS-Fusion의 config 파일에 있는 카메라 파라미터가 바로 이것!

---

## 📖 핵심 개념

### 1. 핀홀 카메라 원리

#### 눈과 카메라의 공통점

```
🌍 3D 세계       📷 카메라/눈         🖼️ 이미지/망막
                     
   물체  ──────────→  [ ● ]  ──────────→  상
                      작은 구멍
                    (pinhole/동공)
```

**왜 "핀홀"인가?**

| 구멍 크기 | 장점 | 단점 |
|---------|------|------|
| 큰 구멍 | 밝은 이미지 | 흐릿함 (여러 방향의 빛이 겹침) |
| 작은 구멍 (핀홀) | 선명한 이미지 | 어두움 (빛이 적게 들어옴) |
| 렌즈 사용 | 밝고 선명 | 왜곡 발생 (Week 2) |

**핀홀 = 이상적인 점 크기의 구멍**
- 한 점에서 나온 빛이 이미지의 **한 점**에만 맺힘
- 수학적으로 가장 단순한 모델
- 실제 렌즈는 이 모델에 왜곡(distortion)을 추가

---

### 2. 좌표계 이해

#### 네 가지 좌표계

```
┌─────────────────────────────────────────────────────────────┐
│                        좌표계 흐름                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🌍 월드 좌표계         📷 카메라 좌표계      🖼️ 이미지 좌표계 │
│  (World Frame)         (Camera Frame)        (Image Frame) │
│       Pw                     Pc                   p        │
│   [Xw, Yw, Zw]           [Xc, Yc, Zc]          [u, v]      │
│                                                             │
│        │                     │                    │        │
│        │  [R|t] 외부 파라미터 │  K 내부 파라미터    │        │
│        └─────────────────────┘────────────────────┘        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

| 좌표계 | 단위 | 원점 | 용도 |
|--------|------|------|------|
| 월드 좌표계 (World) | 미터 | 임의 (보통 시작점) | 3D 맵 표현 |
| 카메라 좌표계 (Camera) | 미터 | 카메라 중심 | 카메라 기준 3D |
| 정규화 이미지 좌표계 | 무차원 | 광축 교점 | 초점거리 1로 정규화 |
| 픽셀 좌표계 (Pixel) | 픽셀 | 이미지 좌상단 | 실제 이미지 좌표 |

---

### 3. 투영 과정 (3D → 2D)

#### Step 1: 월드 → 카메라 (외부 파라미터)

**변환 공식**:
```
Pc = R · Pw + t

또는 동차좌표로:

[Pc]   [R | t] [Pw]
[1 ] = [0 | 1] [1 ]
```

**기억하세요** (Phase 1 Week 5 복습):
- R: 3×3 회전 행렬 (카메라 방향)
- t: 3×1 이동 벡터 (카메라 위치)
- [R|t]: 3×4 외부 파라미터 행렬 (Extrinsic)

**직관적 의미**:
- "월드 좌표를 카메라가 보는 기준으로 바꾸기"
- 카메라가 회전하면 → R 변화
- 카메라가 이동하면 → t 변화

#### Step 2: 카메라 → 정규화 이미지 (투영)

**핵심 연산: 원근 투영 (Perspective Projection)**

```
       Xc                     Yc
x' = ──────            y' = ──────
       Zc                     Zc
```

**왜 Zc로 나눌까?**

```
         ☀️ (먼 물체, 큰 Zc)
          \
           \      📷
    ⭐ (가까운 물체, 작은 Zc)
      \
       \
        ──────────────────  이미지 평면
```

- **가까운 물체** (Zc 작음): 이미지에서 크게 보임
- **먼 물체** (Zc 큼): 이미지에서 작게 보임
- Zc로 나누는 것 = **원근감** 표현!

**비유**: 기찻길이 멀리서 만나 보이는 것과 같은 원리

#### Step 3: 정규화 → 픽셀 (내부 파라미터)

**카메라 내부 행렬 K (Intrinsic Matrix)**:

```
     [fx  0  cx]
K =  [0  fy  cy]
     [0   0   1]
```

**각 요소의 의미**:

| 파라미터 | 의미 | 단위 | 전형적인 값 |
|---------|------|------|------------|
| fx | X축 초점 거리 | 픽셀 | 500~1500 |
| fy | Y축 초점 거리 | 픽셀 | 500~1500 |
| cx | 주점 X 좌표 | 픽셀 | 이미지 너비/2 근처 |
| cy | 주점 Y 좌표 | 픽셀 | 이미지 높이/2 근처 |

**초점 거리 (Focal Length, f)**:

```
        렌즈/핀홀
           │
           │
    ←──f──→│
           │
           │──────────── 이미지 센서
```

- 물리적 초점 거리(mm)와 픽셀 크기로 계산
- `fx = f_mm / pixel_size_x`
- 클수록 → 좁은 시야각 (망원)
- 작을수록 → 넓은 시야각 (광각)

**주점 (Principal Point, cx, cy)**:

- 이론상: 이미지 정중앙
- 실제: 약간 어긋남 (제조 오차)
- 캘리브레이션으로 정확한 값 측정 (Week 2)

**fx ≠ fy인 이유**:
- 이상적: fx = fy (정사각형 픽셀)
- 실제: 센서 픽셀이 완벽한 정사각형이 아닐 수 있음
- 대부분 거의 같지만, 정밀 작업에서는 구별

**최종 픽셀 좌표**:

```
u = fx · x' + cx = fx · (Xc/Zc) + cx
v = fy · y' + cy = fy · (Yc/Zc) + cy
```

---

### 4. 전체 투영 공식

#### 행렬 형태

```
       [u]          [Xw]
   s · [v] = K[R|t] [Yw]
       [1]          [Zw]
                    [1 ]
```

- s: 스케일 팩터 (Zc와 같음)
- K: 3×3 내부 파라미터
- [R|t]: 3×4 외부 파라미터
- 결과: 3×1 동차 좌표 → 나누면 (u, v) 픽셀

#### Python 구현

```python
import numpy as np

def project_point(P_world, R, t, K):
    """
    3D 월드 점을 2D 픽셀로 투영
    
    Args:
        P_world: 3D 점 [X, Y, Z]
        R: 3x3 회전 행렬
        t: 3x1 이동 벡터
        K: 3x3 내부 파라미터 행렬
    
    Returns:
        pixel: [u, v] 픽셀 좌표
    """
    # Step 1: 월드 → 카메라
    P_camera = R @ P_world + t.flatten()
    
    # Step 2: 카메라 → 정규화 이미지 (원근 투영)
    x_normalized = P_camera[0] / P_camera[2]
    y_normalized = P_camera[1] / P_camera[2]
    
    # Step 3: 정규화 → 픽셀
    fx, fy = K[0, 0], K[1, 1]
    cx, cy = K[0, 2], K[1, 2]
    
    u = fx * x_normalized + cx
    v = fy * y_normalized + cy
    
    return np.array([u, v])
```

---

### 5. SLAM에서의 활용

#### VINS-Fusion config 파일 예시

```yaml
# euroc_config.yaml
model_type: PINHOLE
camera_name: cam0

image_width: 752
image_height: 480

# 내부 파라미터 K
projection_parameters:
   fx: 458.654
   fy: 457.296
   cx: 367.215
   cy: 248.375

# 왜곡 계수 (Week 2)
distortion_parameters:
   k1: -0.28340811
   k2: 0.07395907
   p1: 0.00019359
   p2: 1.76187114e-05
```

#### 재투영 오차 (Reprojection Error)

**개념**: 3D 점을 이미지에 투영한 위치와 실제 관측 위치의 차이

```
                실제 관측점 ●
                          /
                         / 재투영 오차
                        /
    투영된 점 ○ ←──────
```

**계산**:
```python
def reprojection_error(P_3d, observed_2d, R, t, K):
    """재투영 오차 계산"""
    projected = project_point(P_3d, R, t, K)
    error = np.linalg.norm(projected - observed_2d)
    return error
```

**SLAM에서 중요한 이유**:
- Bundle Adjustment의 비용 함수
- 최적화 목표: 모든 점의 재투영 오차 합 최소화
- 단위: 픽셀 (보통 1픽셀 이하면 좋음)

---

## 💻 실습 파일

| 파일 | 내용 | 난이도 |
|------|------|--------|
| `pinhole_basics.py` | 투영 함수 구현 및 시각화 | ⭐⭐ |
| `pinhole_quiz.py` | 역투영, 재투영 오차 실습 | ⭐⭐⭐ |

### 실습 내용 미리보기

1. 카메라 내부/외부 파라미터 설정
2. 3D 점 → 2D 픽셀 투영
3. 다양한 카메라 위치에서 투영 결과 비교
4. FOV (시야각) 계산
5. 재투영 오차 시각화

---

## 📊 핵심 정리

### 투영 파이프라인

```
3D 월드 점 (Pw)
      │
      │ [R|t] - 외부 파라미터 (카메라 포즈)
      ▼
3D 카메라 점 (Pc)
      │
      │ 원근 투영 (÷Zc)
      ▼
정규화 이미지 점 (x', y')
      │
      │ K - 내부 파라미터 (카메라 고유)
      ▼
2D 픽셀 점 (u, v)
```

### 핵심 공식

| 단계 | 공식 | 의미 |
|------|------|------|
| 외부 변환 | Pc = R·Pw + t | 월드→카메라 |
| 원근 투영 | (x', y') = (Xc/Zc, Yc/Zc) | 3D→2D |
| 내부 변환 | (u, v) = (fx·x'+cx, fy·y'+cy) | 정규화→픽셀 |

### 파라미터 구분

| 구분 | 파라미터 | 특성 | SLAM에서 |
|------|---------|------|---------|
| 내부 (Intrinsic) | K (fx, fy, cx, cy) | 카메라 고유, 불변 | 캘리브레이션으로 사전 측정 |
| 외부 (Extrinsic) | [R \| t] | 카메라 위치/방향, 변화 | 매 프레임 추정 대상 |

---

## ✅ 학습 완료 체크리스트

### 기초 이해 (필수)
- [ ] 핀홀 카메라가 왜 "핵심 모델"인지 설명 가능
- [ ] 4가지 좌표계 (월드, 카메라, 정규화, 픽셀) 구분 가능
- [ ] 3D→2D 투영 과정 3단계 설명 가능
- [ ] K 행렬의 fx, fy, cx, cy 의미 알기

### 실용 활용 (권장)
- [ ] 투영 함수를 Python으로 구현 가능
- [ ] 어떤 점이 이미지 안에 보이는지 판단 가능
- [ ] 재투영 오차 개념 이해

### 심화 (선택)
- [ ] VINS-Fusion config 파일의 카메라 파라미터 해석 가능
- [ ] 초점 거리와 시야각(FOV)의 관계 이해

---

## 🔗 다음 단계

### Week 2: 렌즈 왜곡과 캘리브레이션

실제 카메라는 핀홀 모델과 다른 점이 있습니다:
- **렌즈 왜곡**: 직선이 휘어 보임
- **캘리브레이션**: K, 왜곡 계수를 실제로 측정
- **왜곡 보정**: 왜곡된 이미지를 펴기

---

## 📚 참고 자료

- OpenCV Camera Calibration Tutorial
- Multiple View Geometry (Hartley & Zisserman) - Chapter 6
- First Principles of Computer Vision (YouTube)

---

## ❓ FAQ

**Q1: 내부 파라미터 K는 언제 바뀌나요?**
A: 보통 안 바뀝니다. 같은 카메라, 같은 렌즈, 같은 줌 설정이면 동일합니다. 한 번 캘리브레이션하면 계속 사용합니다.

**Q2: fx와 fy가 같지 않으면 문제인가요?**
A: 아닙니다. 정상입니다. 차이가 너무 크면 (예: 10% 이상) 캘리브레이션 오류를 의심해볼 수 있습니다.

**Q3: Zc가 음수면 어떻게 되나요?**
A: 점이 카메라 뒤에 있다는 뜻입니다. 투영 불가! SLAM에서는 이런 점을 제외합니다.

**Q4: 왜 동차좌표를 사용하나요?**
A: 이동(translation)을 곱셈으로 표현하기 위해서입니다. (Phase 1 Week 5 복습)

---

**🎯 Week 1 핵심 메시지:**

> 핀홀 카메라 모델은 3D→2D 투영의 수학적 기초입니다.
> 
> **K 행렬** (내부) + **[R|t]** (외부) = 완전한 투영!
