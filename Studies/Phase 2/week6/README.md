# Week 6: í¬ì¦ˆ ì¶”ì • (Pose Estimation from E)

## ğŸ“Œ ê°œìš”

> ğŸ¯ **ëª©í‘œ**: Essential Matrixì—ì„œ ì¹´ë©”ë¼ íšŒì „(R)ê³¼ í‰í–‰ì´ë™(t) ë¶„í•´í•˜ê¸°
> â±ï¸ **ì˜ˆìƒ ì‹œê°„**: ì´ë¡  3ì‹œê°„ + ì‹¤ìŠµ 2ì‹œê°„

ì§€ë‚œ ì£¼ì— Essential Matrixë¥¼ ë°°ì› ìŠµë‹ˆë‹¤. ì´ë²ˆ ì£¼ì—ëŠ” Eì—ì„œ **ì¹´ë©”ë¼ì˜ ìƒëŒ€ í¬ì¦ˆ (R, t)**ë¥¼ ë³µì›í•˜ëŠ” ë°©ë²•ì„ ë°°ì›ë‹ˆë‹¤. ì´ê²ƒì´ Visual Odometryì˜ í•µì‹¬ì…ë‹ˆë‹¤!

### ğŸ¤” ì™œ ì´ê±¸ ë°°ì›Œì•¼ í• ê¹Œìš”?

**ì¼ìƒ ë¹„ìœ **: ë‘ ì‚¬ì§„ì—ì„œ ì¹´ë©”ë¼ê°€ ì–¼ë§ˆë‚˜ ì›€ì§ì˜€ëŠ”ì§€ ì•Œì•„ë‚´ê¸°

```
í”„ë ˆì„ 1                    í”„ë ˆì„ 2
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â—   â—  â”‚    R, t        â”‚    â—  â— â”‚
â”‚    â—    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â–¶     â”‚  â—      â”‚
â”‚  â—      â”‚  ì¹´ë©”ë¼ ì´ë™      â”‚      â—  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Eë¥¼ ì•Œë©´ â†’ R, të¥¼ ì¶”ì •í•  ìˆ˜ ìˆë‹¤!
```

**SLAMì—ì„œì˜ ì¤‘ìš”ì„±**:
- **Visual Odometry**: ë§¤ í”„ë ˆì„ R, t ì¶”ì • â†’ ê²½ë¡œ ì¶”ì •
- **ì´ˆê¸°í™”**: ì²« ë‘ í”„ë ˆì„ì—ì„œ ì´ˆê¸° ë§µ + í¬ì¦ˆ
- **ì¬ìœ„ì¹˜í™”**: ì¶”ì  ì‹¤íŒ¨ ì‹œ ìœ„ì¹˜ ë³µêµ¬

---

## ğŸ“– í•µì‹¬ ê°œë…

### 1. Eì—ì„œ R, t ë¶„í•´ ì›ë¦¬

#### E = [t]Ã— R ë³µìŠµ

```
E = [t]Ã— Â· R

ì—¬ê¸°ì„œ:
- [t]Ã—: tì˜ ë°˜ëŒ€ì¹­ í–‰ë ¬ (3Ã—3, rank 2)
- R: íšŒì „ í–‰ë ¬ (3Ã—3)
```

**ëª©í‘œ**: Eê°€ ì£¼ì–´ì¡Œì„ ë•Œ, [t]Ã—ì™€ R ë¶„ë¦¬!

#### SVD ë¶„í•´

```
E = U Â· Î£ Â· Váµ€

ì—¬ê¸°ì„œ:
- U: 3Ã—3 ì§êµ í–‰ë ¬
- Î£ = diag(Ïƒ, Ïƒ, 0): ë‘ íŠ¹ì´ê°’ì´ ê°™ê³  í•˜ë‚˜ëŠ” 0
- Váµ€: 3Ã—3 ì§êµ í–‰ë ¬
```

**í•µì‹¬ í–‰ë ¬ W**:

```
     [ 0  -1   0 ]
W =  [ 1   0   0 ]  (90Â° Zì¶• íšŒì „)
     [ 0   0   1 ]
```

---

### 2. 4ê°€ì§€ ê°€ëŠ¥í•œ í•´

#### R, t ë¶„í•´ ê³µì‹

```
Râ‚ = U Â· Wáµ€ Â· Váµ€       tâ‚ = +Uâ‚ƒ  (Uì˜ 3ë²ˆì§¸ ì—´)
Râ‚‚ = U Â· Wáµ€ Â· Váµ€       tâ‚‚ = -Uâ‚ƒ

Râ‚ƒ = U Â· W Â· Váµ€        tâ‚ƒ = +Uâ‚ƒ
Râ‚„ = U Â· W Â· Váµ€        tâ‚„ = -Uâ‚ƒ
```

ì¦‰, **4ê°€ì§€ (R, t) ì¡°í•©** ê°€ëŠ¥:
1. (Râ‚, +t)
2. (Râ‚, -t)
3. (Râ‚‚, +t)
4. (Râ‚‚, -t)

**ì™œ 4ê°€ì§€?**

```
ì¹´ë©”ë¼ ì•                    ì¹´ë©”ë¼ ë’¤
     P â—                         â— P'
      â•²                         â•±
       â•²                       â•±
        â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—
       Câ‚                      Câ‚‚

Pì™€ P'ëŠ” ê°™ì€ ì´ë¯¸ì§€ ì¢Œí‘œë¥¼ ìƒì„±!
â†’ ê¸°í•˜í•™ì ìœ¼ë¡œ êµ¬ë¶„ í•„ìš” (Cheirality Check)
```

---

### 3. Cheirality Check (ê¹Šì´ ì–‘ìˆ˜ ê²€ì‚¬)

#### ì˜¬ë°”ë¥¸ í•´ ì„ íƒ ê¸°ì¤€

**3D ì ì´ ë‘ ì¹´ë©”ë¼ ëª¨ë‘ì˜ ì•ì— ìˆì–´ì•¼!**

```
ì˜¬ë°”ë¥¸ ê²½ìš°:              ì˜ëª»ëœ ê²½ìš°:

    â— P                   Câ‚ â—â”€â”€â”€â”€â”€â”€â”€â— P
   â•± â•²                         â•²
  â•±   â•²                         â•²
 â—     â—                         â—
Câ‚    Câ‚‚                        Câ‚‚

Z > 0 (ë‘ ì¹´ë©”ë¼ ì•)     Z < 0 (ì¹´ë©”ë¼ ë’¤)
```

**ê²€ì‚¬ ë°©ë²•**:
1. ê° (R, t) ì¡°í•©ìœ¼ë¡œ 3D ì  ì‚¼ê°ì¸¡ëŸ‰
2. ì‚¼ê°ì¸¡ëŸ‰ëœ ì ì˜ Z ì¢Œí‘œ í™•ì¸
3. **ë‘ ì¹´ë©”ë¼ ê¸°ì¤€ ëª¨ë‘ Z > 0**ì¸ í•´ ì„ íƒ

```python
def cheirality_check(R, t, pts1, pts2, K):
    """
    Cheirality Check: Z > 0ì¸ ì  ë¹„ìœ¨ ë°˜í™˜
    """
    P1 = K @ np.eye(3, 4)  # [I|0]
    P2 = K @ np.hstack([R, t.reshape(3, 1)])  # [R|t]
    
    count = 0
    for p1, p2 in zip(pts1, pts2):
        # ì‚¼ê°ì¸¡ëŸ‰
        X = triangulate(P1, P2, p1, p2)
        
        # ì¹´ë©”ë¼ 1ì—ì„œ Z > 0?
        if X[2] > 0:
            # ì¹´ë©”ë¼ 2ì—ì„œ Z > 0?
            X_cam2 = R @ X + t
            if X_cam2[2] > 0:
                count += 1
    
    return count / len(pts1)
```

---

### 4. ì „ì²´ í¬ì¦ˆ ì¶”ì • íŒŒì´í”„ë¼ì¸

```
ëŒ€ì‘ì  (pts1, pts2)
        â”‚
        â–¼
Essential Matrix ê³„ì‚°
   cv2.findEssentialMat()
        â”‚
        â–¼
R, t ë¶„í•´ (4ê°€ì§€ í•´)
   cv2.decomposeEssentialMat()
        â”‚
        â–¼
ì‚¼ê°ì¸¡ëŸ‰ + Cheirality Check
        â”‚
        â–¼
ì˜¬ë°”ë¥¸ (R, t) ì„ íƒ
   cv2.recoverPose()
```

#### OpenCV recoverPose

```python
import cv2
import numpy as np

# Essential Matrix ê³„ì‚°
E, mask = cv2.findEssentialMat(pts1, pts2, K, 
                                method=cv2.RANSAC, 
                                prob=0.999, 
                                threshold=1.0)

# R, t ë³µì› (ìë™ìœ¼ë¡œ Cheirality Check)
_, R, t, mask_pose = cv2.recoverPose(E, pts1, pts2, K)

print(f"R:\n{R}")
print(f"t: {t.flatten()}")
```

---

### 5. ìŠ¤ì¼€ì¼ ëª¨í˜¸ì„±

#### ì¤‘ìš”í•œ í•œê³„

```
Eì—ì„œ ì–»ì€ tëŠ” ë°©í–¥ë§Œ ì •í™•!
í¬ê¸°(ìŠ¤ì¼€ì¼)ëŠ” ì•Œ ìˆ˜ ì—†ìŒ!

ì‹¤ì œ ì´ë™: t = [0.5, 0, 0.1]m
Eì—ì„œ ë³µì›: t' = [0.98, 0, 0.19] (ë‹¨ìœ„ ë²¡í„°)
```

**ì´ìœ **:
- E = [t]Ã— R ì—ì„œ të¥¼ Î»të¡œ ë°”ê¿”ë„ ê°™ì€ E
- ë‹¨ì¼ ì¹´ë©”ë¼(Monocular)ì˜ ê·¼ë³¸ì  í•œê³„

**í•´ê²° ë°©ë²•**:

| ë°©ë²• | ì„¤ëª… |
|------|------|
| **Stereo** | ë² ì´ìŠ¤ë¼ì¸ ì•Œë ¤ì§ â†’ ì ˆëŒ€ ìŠ¤ì¼€ì¼ |
| **IMU ìœµí•©** | ê°€ì†ë„ë¡œ ìŠ¤ì¼€ì¼ ì¶”ì • (VINS) |
| **ì•Œë ¤ì§„ ë¬¼ì²´** | ë¬¼ì²´ í¬ê¸°ë¡œ ìŠ¤ì¼€ì¼ ì¶”ì • |
| **ì—°ì† í”„ë ˆì„** | ìƒëŒ€ ìŠ¤ì¼€ì¼ë§Œ (drift ë°œìƒ) |

---

### 6. íšŒì „ í–‰ë ¬ ê²€ì¦

#### Rì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸

```python
def is_valid_rotation(R):
    """íšŒì „ í–‰ë ¬ ê²€ì¦"""
    # 1. ì§êµì„±: Ráµ€R = I
    orthogonal = np.allclose(R.T @ R, np.eye(3), atol=1e-6)
    
    # 2. í–‰ë ¬ì‹: det(R) = 1
    det = np.linalg.det(R)
    proper = np.isclose(det, 1.0, atol=1e-6)
    
    return orthogonal and proper
```

**ì£¼ì˜**: det(R) = -1ì´ë©´ ë°˜ì‚¬ í–‰ë ¬ (ì˜ëª»ëœ í•´)

---

### 7. ì‹¤ì „ ê³ ë ¤ì‚¬í•­

#### í¬ì¦ˆ ì¶”ì • ì‹¤íŒ¨ ì¼€ì´ìŠ¤

| ì¼€ì´ìŠ¤ | ì„¤ëª… | í•´ê²° |
|--------|------|------|
| ìˆœìˆ˜ íšŒì „ | t â‰ˆ 0 | E ì •ì˜ ì•ˆ ë¨, ë‹¤ë¥¸ í”„ë ˆì„ ì‚¬ìš© |
| ê³µë©´ ì ë“¤ | ëª¨ë“  ì ì´ í‰ë©´ ìœ„ | Homography ì‚¬ìš© |
| ì ì€ ë§¤ì¹­ | < 5ì  | ë” ë§ì€ íŠ¹ì§•ì  í•„ìš” |
| ë§ì€ outlier | RANSAC ì‹¤íŒ¨ | threshold ì¡°ì • |

#### VINS-Fusionì—ì„œì˜ ì‚¬ìš©

```
sfm.cpp / initial_sfm.cpp:

1. KLTë¡œ íŠ¹ì§•ì  ì¶”ì 
2. 5-point RANSACìœ¼ë¡œ E ê³„ì‚°
3. recoverPoseë¡œ R, t ë¶„í•´
4. ì‚¼ê°ì¸¡ëŸ‰ìœ¼ë¡œ ì´ˆê¸° ë§µ ìƒì„±
5. IMU ì‚¬ì „ì ë¶„ê³¼ ê²°í•©í•˜ì—¬ ìŠ¤ì¼€ì¼ ì¶”ì •
```

---

## ğŸ’» ì‹¤ìŠµ íŒŒì¼

| íŒŒì¼ | ë‚´ìš© | ë‚œì´ë„ |
|------|------|--------|
| `pose_estimation_basics.py` | E â†’ R, t ë¶„í•´, Cheirality | â­â­â­ |
| `pose_estimation_quiz.py` | 4ê°€ì§€ í•´ ë¹„êµ, ìŠ¤ì¼€ì¼ ë¶„ì„ | â­â­â­ |

---

## ğŸ“Š í•µì‹¬ ì •ë¦¬

### E â†’ R, t ë¶„í•´ ìš”ì•½

```
E = U Â· Î£ Â· Váµ€ (SVD)
        â”‚
        â–¼
W = [0 -1 0; 1 0 0; 0 0 1]
        â”‚
        â–¼
Râ‚ = UÂ·Wáµ€Â·Váµ€,  Râ‚‚ = UÂ·WÂ·Váµ€
tâ‚ = +Uâ‚ƒ,       tâ‚‚ = -Uâ‚ƒ
        â”‚
        â–¼
4ê°€ì§€ ì¡°í•© ì¤‘ Cheirality Check
        â”‚
        â–¼
ìœ ì¼í•œ ì˜¬ë°”ë¥¸ (R, t)
```

### ê³µì‹ ìš”ì•½

| ë‹¨ê³„ | ê³µì‹ |
|------|------|
| E ì •ì˜ | E = [t]Ã— R |
| SVD | E = U Î£ Váµ€ |
| R í›„ë³´ | R = U W(áµ€) Váµ€ |
| t í›„ë³´ | t = Â± Uâ‚ƒ |
| ê²€ì¦ | det(R) = 1, Ráµ€ R = I |

---

## âœ… í•™ìŠµ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ê¸°ì´ˆ ì´í•´ (í•„ìˆ˜)
- [ ] Eì—ì„œ ì™œ 4ê°€ì§€ í•´ê°€ ë‚˜ì˜¤ëŠ”ì§€ ì„¤ëª… ê°€ëŠ¥
- [ ] Cheirality Check ì›ë¦¬ ì„¤ëª… ê°€ëŠ¥
- [ ] ìŠ¤ì¼€ì¼ ëª¨í˜¸ì„± ì´í•´

### ì‹¤ìš© í™œìš© (ê¶Œì¥)
- [ ] cv2.recoverPose() ì‚¬ìš© ê°€ëŠ¥
- [ ] íšŒì „ í–‰ë ¬ ê²€ì¦ ê°€ëŠ¥
- [ ] 4ê°€ì§€ í•´ ì¤‘ ì˜¬ë°”ë¥¸ í•´ ì„ íƒ ì´í•´

### ì‹¬í™” (ì„ íƒ)
- [ ] SVD ë¶„í•´ ìœ ë„ ì´í•´
- [ ] W í–‰ë ¬ì˜ ê¸°í•˜í•™ì  ì˜ë¯¸ ì´í•´
- [ ] VINS ì´ˆê¸°í™” ì½”ë“œ ë¶„ì„

---

## ğŸ”— ë‹¤ìŒ ë‹¨ê³„

### Week 7: ì‚¼ê°ì¸¡ëŸ‰ê³¼ PnP

R, të¥¼ ì•Œë©´:
- **ì‚¼ê°ì¸¡ëŸ‰**: 2D ì ë“¤ â†’ 3D ì  ë³µì›
- **PnP**: 3D-2D ëŒ€ì‘ â†’ ìƒˆ í”„ë ˆì„ í¬ì¦ˆ ì¶”ì •

---

## ğŸ“š ì°¸ê³  ìë£Œ

- Multiple View Geometry (Hartley & Zisserman) - Chapter 9.6
- OpenCV recoverPose documentation
- VINS-Fusion initial_sfm.cpp

---

## â“ FAQ

**Q1: det(R) = -1ì´ ë‚˜ì˜¤ë©´?**
A: Rì— -1ì„ ê³±í•˜ë©´ ë©ë‹ˆë‹¤. ë˜ëŠ” Uë‚˜ Vì˜ ë¶€í˜¸ ì¡°ì •.

**Q2: ëª¨ë“  í•´ì—ì„œ Cheirality ì‹¤íŒ¨í•˜ë©´?**
A: E ì¶”ì •ì´ ì˜ëª»ëê±°ë‚˜, ìˆœìˆ˜ íšŒì „ì¸ ê²½ìš°. ë‹¤ë¥¸ í”„ë ˆì„ ì‚¬ìš©.

**Q3: tì˜ í¬ê¸°ëŠ” ì–´ë–»ê²Œ ì •í•˜ë‚˜ìš”?**
A: MonocularëŠ” ëª» ì •í•¨. ì²« í”„ë ˆì„ t=1ë¡œ ì„¤ì •í•˜ê³  ìƒëŒ€ ìŠ¤ì¼€ì¼ë§Œ.

**Q4: OpenCVê°€ ìë™ìœ¼ë¡œ í•´ì£¼ëŠ” ê±´?**
A: `recoverPose()`ê°€ 4ê°€ì§€ í•´ í…ŒìŠ¤íŠ¸ + Cheirality Checkë¥¼ ìë™ ìˆ˜í–‰.

---

**ğŸ¯ Week 6 í•µì‹¬ ë©”ì‹œì§€:**

> E â†’ R, t ë¶„í•´ = Visual Odometryì˜ í•µì‹¬
> 
> **4ê°€ì§€ í•´ ì¤‘ Cheirality Checkë¡œ ì˜¬ë°”ë¥¸ í•´ ì„ íƒ!**
